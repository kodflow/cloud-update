FROM alpine:3.19

# Install minimal dependencies - no bash needed
RUN apk add --no-cache \
    curl \
    openssl \
    openrc

# Setup OpenRC
RUN mkdir -p /run/openrc && \
    touch /run/openrc/softlevel && \
    rc-status || (echo "Setup failed, but continuing for testing..." && exit 0)

# Copy the pre-built binary and install script
WORKDIR /app
# First try to copy from test directory, fallback to dist
COPY src/test/e2e/cloud-update /app/cloud-update
COPY scripts/install.sh /app/install.sh

# Make scripts executable
RUN chmod 755 /app/cloud-update /app/install.sh

# Set test environment variables
ENV CLOUD_UPDATE_SECRET=test-secret-key-for-e2e-testing-purposes-only
ENV CLOUD_UPDATE_PORT=9999
ENV CLOUD_UPDATE_LOG_LEVEL=debug

# Run installation with sh (POSIX-compliant)
RUN sh /app/install.sh

# Health check
HEALTHCHECK --interval=5s --timeout=3s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:9999/health || exit 1

EXPOSE 9999

# Start the service directly
CMD ["/opt/cloud-update/cloud-update"]