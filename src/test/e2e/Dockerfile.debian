FROM debian:12

# Install dependencies (Debian can use either systemd or sysvinit)
RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copy the pre-built binary
WORKDIR /app
# Copy from project root (context is ../../..)
COPY src/test/e2e/cloud-update /usr/local/bin/cloud-update

# Make binary executable
RUN chmod 755 /usr/local/bin/cloud-update

# Set test environment variables
ENV CLOUD_UPDATE_SECRET=test-secret-key-for-e2e-testing-purposes-only
ENV CLOUD_UPDATE_PORT=8080
ENV CLOUD_UPDATE_LOG_LEVEL=debug

# Run setup using the binary directly
RUN /usr/local/bin/cloud-update --setup

# Health check
HEALTHCHECK --interval=5s --timeout=3s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

EXPOSE 8080

# Start the service directly
CMD ["/usr/local/bin/cloud-update"]